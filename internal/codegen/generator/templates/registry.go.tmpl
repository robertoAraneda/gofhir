{{- /* Template for generating registry.go */ -}}
// Code generated by gofhir. DO NOT EDIT.
// Source: FHIR StructureDefinitions (registry)
// Package: {{.PackageName}}

package {{.PackageName}}

import (
	"encoding/json"
	"fmt"
)

// resourceFactories maps resourceType to factory function.
var resourceFactories = map[string]func() Resource{
{{- range .ResourceNames}}
	"{{.}}": func() Resource { return &{{.}}{} },
{{- end}}
}

// NewResource creates an empty instance of the specified resource type.
// Returns an error if the resource type is unknown.
func NewResource(resourceType string) (Resource, error) {
	factory, ok := resourceFactories[resourceType]
	if !ok {
		return nil, fmt.Errorf("unknown resource type: %s", resourceType)
	}
	return factory(), nil
}

// UnmarshalResource deserializes JSON to the correct resource type.
// It first peeks at the resourceType field to determine the type,
// then unmarshals the full JSON into the appropriate struct.
func UnmarshalResource(data []byte) (Resource, error) {
	resourceType, err := GetResourceType(data)
	if err != nil {
		return nil, fmt.Errorf("failed to get resource type: %w", err)
	}

	resource, err := NewResource(resourceType)
	if err != nil {
		return nil, err
	}

	if err := json.Unmarshal(data, resource); err != nil {
		return nil, fmt.Errorf("failed to unmarshal %s: %w", resourceType, err)
	}

	return resource, nil
}

// GetResourceType extracts the resourceType from JSON without fully deserializing.
// This is useful for routing or validation before full deserialization.
func GetResourceType(data []byte) (string, error) {
	var peek struct {
		ResourceType string `json:"resourceType"`
	}
	if err := json.Unmarshal(data, &peek); err != nil {
		return "", fmt.Errorf("failed to parse JSON: %w", err)
	}
	if peek.ResourceType == "" {
		return "", fmt.Errorf("resourceType field is missing or empty")
	}
	return peek.ResourceType, nil
}

// IsKnownResourceType returns true if the given resource type is known.
func IsKnownResourceType(resourceType string) bool {
	_, ok := resourceFactories[resourceType]
	return ok
}

// AllResourceTypes returns a slice of all known resource type names.
func AllResourceTypes() []string {
	types := make([]string, 0, len(resourceFactories))
	for t := range resourceFactories {
		types = append(types, t)
	}
	return types
}
