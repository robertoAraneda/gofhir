{{- /* Template for generating backbones.go */ -}}
// Code generated by gofhir. DO NOT EDIT.
// Source: FHIR StructureDefinitions (backbone elements)
// Package: {{.PackageName}}

package {{.PackageName}}

{{- /* Check if any backbone has a Resource field to determine if we need imports */ -}}
{{- $needsImports := false -}}
{{- range .Backbones -}}
{{- range .Properties -}}
{{- if eq .GoType "Resource" -}}
{{- $needsImports = true -}}
{{- end -}}
{{- end -}}
{{- end -}}

{{- if $needsImports }}

import (
	"encoding/json"
	"fmt"
)
{{- end }}

{{range .Backbones}}
{{- /* Check if this backbone has a Resource field */ -}}
{{- $hasResourceField := false -}}
{{- $resourceFieldName := "" -}}
{{- $resourceJSONName := "" -}}
{{- range .Properties -}}
{{- if eq .GoType "Resource" -}}
{{- $hasResourceField = true -}}
{{- $resourceFieldName = .Name -}}
{{- $resourceJSONName = .JSONName -}}
{{- end -}}
{{- end -}}

// {{.Name}} represents the {{.FHIRName}} backbone element.
{{- if .Description}}
// {{.Description}}
{{- end}}
type {{.Name}} struct {
{{- range .Properties}}
	{{- if .Description}}
	// {{.Description}}
	{{- end}}
	{{.Name}} {{.GoType}} `json:"{{.JSONName}},omitempty"`
{{- end}}
}

{{- if $hasResourceField }}

// UnmarshalJSON handles deserialization of polymorphic resource field.
func (b *{{.Name}}) UnmarshalJSON(data []byte) error {
	// Use an alias to avoid infinite recursion
	type Alias {{.Name}}
	aux := &struct {
		{{$resourceFieldName}} json.RawMessage `json:"{{$resourceJSONName}},omitempty"`
		*Alias
	}{
		Alias: (*Alias)(b),
	}

	if err := json.Unmarshal(data, aux); err != nil {
		return err
	}

	// Unmarshal the resource field using the dispatcher
	if len(aux.{{$resourceFieldName}}) > 0 {
		resource, err := UnmarshalResource(aux.{{$resourceFieldName}})
		if err != nil {
			return fmt.Errorf("failed to unmarshal {{$resourceJSONName}}: %w", err)
		}
		b.{{$resourceFieldName}} = resource
	}

	return nil
}
{{- end }}

{{end}}
